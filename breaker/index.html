
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../imgs/favicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.8">
    
    
      
        <title>🔌 Circuit breaker - Construindo APIs robustas</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="amber">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#circuit-breaker" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabeçalho">
    <a href=".." title="Construindo APIs robustas" class="md-header__button md-logo" aria-label="Construindo APIs robustas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c-1.11 0-2 .89-2 2a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2M1 2v2h2l3.6 7.59-1.36 2.45c-.15.28-.24.61-.24.96a2 2 0 0 0 2 2h12v-2H7.42a.25.25 0 0 1-.25-.25c0-.05.01-.09.03-.12L8.1 13h7.45c.75 0 1.41-.42 1.75-1.03l3.58-6.47c.07-.16.12-.33.12-.5a1 1 0 0 0-1-1H5.21l-.94-2M7 18c-1.11 0-2 .89-2 2a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Construindo APIs robustas
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              🔌 Circuit breaker
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Pesquisar">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando a pesquisa
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cassiobotaro/construindo-apis-robustas" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cassiobotaro/construindo-apis-robustas
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegação" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Construindo APIs robustas" class="md-nav__button md-logo" aria-label="Construindo APIs robustas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c-1.11 0-2 .89-2 2a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2M1 2v2h2l3.6 7.59-1.36 2.45c-.15.28-.24.61-.24.96a2 2 0 0 0 2 2h12v-2H7.42a.25.25 0 0 1-.25-.25c0-.05.01-.09.03-.12L8.1 13h7.45c.75 0 1.41-.42 1.75-1.03l3.58-6.47c.07-.16.12-.33.12-.5a1 1 0 0 0-1-1H5.21l-.94-2M7 18c-1.11 0-2 .89-2 2a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0-2-2Z"/></svg>

    </a>
    Construindo APIs robustas
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cassiobotaro/construindo-apis-robustas" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    cassiobotaro/construindo-apis-robustas
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        ▶️ Introdução
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../planejando/" class="md-nav__link">
        💭 Planejando o que será desenvolvido
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ferramentas/" class="md-nav__link">
        🧰 Escolhendo as melhores ferramentas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projeto/" class="md-nav__link">
        📐 Iniciando o projeto
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ola_api/" class="md-nav__link">
        👋 Olá API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../externos/" class="md-nav__link">
        🤝 Integração com serviços externos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../docs/" class="md-nav__link">
        📜 Documentação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../continua/" class="md-nav__link">
        ✔️ Integração contínua
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../desafios/" class="md-nav__link">
        🏆 Desafios
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../assincrono/" class="md-nav__link">
        🐆 Processos assíncronos
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        🔌 Circuit breaker
      </a>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../avancadas/" class="md-nav__link">
        🦸 Técnicas (um pouco mais avançadas)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../referencias/" class="md-nav__link">
        📑 Referências e Dicas
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/cassiobotaro/construindo-apis-robustas/edit/master/docs/breaker.md" title="Editar esta página" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="circuit-breaker">🔌 Circuit breaker</h1>
<p><img alt="" src="../imgs/disjuntor.jpg" /></p>
<h1 id="o-problema">🔥 O problema</h1>
<p>Sistemas falham! E devemos estar preparados pra quando isto ocorrer.</p>
<p>Se tudo foi implementado até o momento (incluindo os desafios), nós temos integrações com dois sistemas distintos. E se um deles falhar? ou ambos? Vamos parar todo o nosso sistema por conta disto?</p>
<p>E como saber se não é apenas uma instabilidade? E se é uma falha de rede? </p>
<p>Você talvez já tenha ouvido falar em <a href="https://docs.microsoft.com/pt-br/azure/architecture/patterns/retry">retentativas</a> em cenários de integração, mas essas retentativas podem degradar ainda mais o sistema ao qual estamos integrando.</p>
<p>🙀 E agora? O que podemos fazer?</p>
<p>E se puxássemos o plug que liga nosso sistema ao sistema externo temporariamente?</p>
<p>O que vamos falar aqui se aplica a integrações com sistemas de terceiros ou sistemas distribuídos internos.</p>
<h2 id="circuit-breaker_1">🔌 Circuit breaker</h2>
<p>A tradução seria, "disjuntor", e seu papel na eletrônica é abrir o circuito que apresenta falha evitando uma sobrecarga de seus componentes. Esse termo também é utilizado na bolsa de valores para quando há uma grande instabilidade (uma forte queda por exemplo), assim a bolsa de valores interrompe as negociações temporariamente, evitando maiores perdas nesses momentos.</p>
<p>Notaram uma semelhança na utilização do conceito? Temos uma falha e uma "abertura" do circuito para evitar maiores danos.</p>
<p>Assim funciona o <em>circuit breaker</em> na computação. Quando falamos em abrir um circuito, estamos falando na verdade em interromper a comunicação entre sistemas (temporariamente).</p>
<p>Nygard em seu livro <a href="https://www.amazon.com.br/Release-It-Nygard-Dahl/dp/8573500862">Release It</a> explica bem o circuit breaker.</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>[...] circuit breakers protect overeager gadget hounds from burning their houses down. The principle is the same: detect excess usage, fail first, and open the circuit. More abstractly, the circuit breaker exists to allow one subsystem (an electrical circuit) to fail (excessive current draw, possibly from a short circuit) without destroying the entire system (the house). Furthermore, once the danger has passed, the circuit breaker can be reset to restore full function to the system.</p>
</div>
<p>Nosso sistema tem os seguintes estados:</p>
<p>Estado fechado: é o estado onde tudo está funcionando normalmente e as requisições serão feitas normalmente. Quando alguma condição de falha é detectada, o circuito é aberto.</p>
<p>Estado aberto: é o estado onde o circuito está aberto e as requisições não serão executadas. Um erro será retornado ou uma informação presente em cache.</p>
<p>Estado semi aberto: é o estado posterior ao estado aberto. Um teste é feito para verificar a condição atual do circuito, se uma falha ocorrer, o estado será alternado para aberto novamente, mas se for bem-sucedido, ele volta para o estado fechado. </p>
<h2 id="demonstracao-e-solucao">🧑‍🏫 Demonstração e Solução</h2>
<p>Vamos fazer uma simulação utilizando código para visualisar melhor este cenário.</p>
<p>Crie um arquivo de exemplo como visto abaixo e execute-o para ver na prática o que estamos falando.</p>
<p>Para executa-lo utilize: <code>python exemplo_circuito_breaker.py</code></p>
<div class="highlight"><span class="filename">exemplo_circuito_breaker.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">import</span> <span class="nn">httpx</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">recupera_produto</span><span class="p">(</span><span class="n">codigo</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recuperando produto de código </span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">cliente</span><span class="p">:</span>
            <span class="n">resposta</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cliente</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://localhost:8000/catalogs/</span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">resposta</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">resposta</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao recuperar produto de código </span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">codigo_produtos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;155568600&quot;</span><span class="p">,</span> <span class="s2">&quot;jj2a97g940&quot;</span><span class="p">,</span> <span class="s2">&quot;cb9a1801k9&quot;</span><span class="p">,</span> <span class="s2">&quot;224722100&quot;</span><span class="p">,</span> <span class="s2">&quot;702915400&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">recupera_produto</span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span> <span class="k">for</span> <span class="n">codigo</span> <span class="ow">in</span> <span class="n">codigo_produtos</span><span class="p">),</span>
    <span class="p">)</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Como as APIs abertas do Magalu se encontram em alpha, uma autorização prévia é necessária. Por isso, você pode utilizar uma versão simulada da mesma.</p>
<p>As instruções de instalação e execução se encontram no readme do <a href="./apis-simuladas">projeto</a>.</p>
</div>
<p>Este código simula o que chamamos de estado de circuito fechado, as chamadas a api externa estão sendo feitas e respondendo normalmente.</p>
<p>Agora vamos introduzir um pouco de caos e ver o que acontece.</p>
<p>Se estiver acompanhando o tutorial posteriormente, modifique a variável de ambiente <code>FAIL_RATE</code> para 70 (valor expresso em porcentagem) e execute o código da api simulada novamente.</p>
<p>Rode novamente nosso código (talvez seja necessário rodar algumas vezes) e veja o que acontece: <code>python exemplo_circuito_breaker.py</code>.</p>
<p>Repare que agora um número menor de pedidos são retornados com sucesso e falhas ocorrem de forma intermitente.</p>
<p>Por algum motivo qualquer, algumas chamadas a api externa respondem com erro. Isto pode significar um problema de rede, uma falha na api externa, sobrecarga de requisições na api externa, etc.</p>
<p>Precisamos dar um tempo para ver se o sistema que estamos interagindo se recupera.</p>
<p>Vamos introduzir então um <code>circuit breaker</code> para modificarmos nosso sistema para um estado aberto.</p>
<p>O luizalabs desenvolveu e mantém como projeto open source o <a href="https://github.com/luizalabs/lasier">lasier</a>, uma implementação de circuit breaker com suporte a processos síncronos e assíncronos.</p>
<p>Para não precisarmos adicionar maior complexidade ao exemplo utilizaremos um cache em memória para guardar as informações do nosso circuito (como número de requisições que falharam). Esse cache em memória será feito utilizando a biblioteca <a href="https://github.com/aio-libs/aiocache">aiocache</a>.</p>
<p>Primeiro passo é instalar as duas bibliotecas que serão necessárias:</p>
<p>Lasier:</p>
<div class="highlight"><pre><span></span><code>poetry add lasier
</code></pre></div>
<p>Aiocache:</p>
<div class="highlight"><pre><span></span><code>poetry add aiocache
</code></pre></div>
<p>Próximo passo é definir uma regra de quando vamos abrir o circuito:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...</span>
<span class="kn">from</span> <span class="nn">lasier.circuit_breaker.rules</span> <span class="kn">import</span> <span class="n">PercentageFailuresRule</span>

<span class="n">rule</span> <span class="o">=</span> <span class="n">PercentageFailuresRule</span><span class="p">(</span>
    <span class="c1"># Numero escolhido para facilitar </span>
    <span class="c1"># a visualização da solução do problema</span>
    <span class="n">max_failures_percentage</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">failure_cache_key</span><span class="o">=</span><span class="s1">&#39;my_cb&#39;</span><span class="p">,</span>
    <span class="n">min_accepted_requests</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">request_cache_key</span><span class="o">=</span><span class="s1">&#39;my_cb_request&#39;</span>
<span class="p">)</span>
<span class="c1"># ...</span>
</code></pre></div>
<p>Essa configuração pode ser feita baseada também em número de <a href="https://github.com/luizalabs/lasier#maxfailuresrule">requisições com falha</a>.</p>
<p>Além da regra de abertura do circuito, vamos definir um cache para armazenar as informações do circuito e das requisições que falharam.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...</span>
<span class="kn">from</span> <span class="nn">aiocache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">lasier.adapters.caches</span> <span class="kn">import</span> <span class="n">AiocacheAdapter</span>
<span class="c1"># ...</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">AiocacheAdapter</span><span class="p">(</span><span class="n">Cache</span><span class="p">(</span><span class="n">Cache</span><span class="o">.</span><span class="n">MEMORY</span><span class="p">))</span>
</code></pre></div>
<p>E agora vamos definir o circuito:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">from</span> <span class="nn">aiocache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">lasier.adapters.caches</span> <span class="kn">import</span> <span class="n">AiocacheAdapter</span>
<span class="kn">from</span> <span class="nn">lasier.circuit_breaker.asyncio</span> <span class="kn">import</span> <span class="n">CircuitBreaker</span>
<span class="kn">from</span> <span class="nn">lasier.circuit_breaker.rules</span> <span class="kn">import</span> <span class="n">PercentageFailuresRule</span>

<span class="n">rule</span> <span class="o">=</span> <span class="n">PercentageFailuresRule</span><span class="p">(</span>
    <span class="c1"># Numero escolhido para facilitar</span>
    <span class="c1"># a visualização da solução do problema</span>
    <span class="n">max_failures_percentage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">failure_cache_key</span><span class="o">=</span><span class="s2">&quot;my_cb&quot;</span><span class="p">,</span>
    <span class="n">min_accepted_requests</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">request_cache_key</span><span class="o">=</span><span class="s2">&quot;my_cb_request&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cache</span> <span class="o">=</span> <span class="n">AiocacheAdapter</span><span class="p">(</span><span class="n">Cache</span><span class="p">(</span><span class="n">Cache</span><span class="o">.</span><span class="n">MEMORY</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">OpenCircuitError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">with_circuit_breaker</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">async</span> <span class="k">with</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
                <span class="n">rule</span><span class="p">,</span>
                <span class="n">cache</span><span class="p">,</span>
                <span class="n">failure_exception</span><span class="o">=</span><span class="n">OpenCircuitError</span><span class="p">,</span>
                <span class="n">catch_exceptions</span><span class="o">=</span><span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span><span class="p">,),</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">OpenCircuitError</span><span class="p">:</span>
            <span class="c1"># aqui poderia vir um tratamento para</span>
            <span class="c1"># quando o circuito está aberto como:</span>
            <span class="c1"># - enviar um email para o time</span>
            <span class="c1"># - reagendar a execução da função</span>
            <span class="c1"># - recuperar o valor armazenado em cache</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;O circuito está aberto, alguma ação pode ser tomada.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="nd">@with_circuit_breaker</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">recupera_produto</span><span class="p">(</span><span class="n">codigo</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recuperando produto de código </span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">cliente</span><span class="p">:</span>
        <span class="n">resposta</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cliente</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://localhost:8000/catalogs/</span><span class="si">{</span><span class="n">codigo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">resposta</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">resposta</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">codigo_produtos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;155568600&quot;</span><span class="p">,</span> <span class="s2">&quot;jj2a97g940&quot;</span><span class="p">,</span> <span class="s2">&quot;cb9a1801k9&quot;</span><span class="p">,</span> <span class="s2">&quot;224722100&quot;</span><span class="p">,</span> <span class="s2">&quot;702915400&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">recupera_produto</span><span class="p">(</span><span class="n">codigo</span><span class="p">)</span> <span class="k">for</span> <span class="n">codigo</span> <span class="ow">in</span> <span class="n">codigo_produtos</span><span class="p">),</span>
    <span class="p">)</span>


<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>Eu decidi criar um decorador para introduzir o circuit breaker. Ao perceber que o circuito está aberto, ele não executa a função, mas sim retorna um erro alertando sobre a abertura do circuito e uma ação pode ser tomada.</p>
<blockquote>
<p>💁 Você deve estar se perguntando: "E como funciona o estado semi aberto?". Infelizmente isto ainda não foi implementado e por padrão o circuito será fechado em 60 segundos, ou outro valor configurado.
Mas como é um projeto de código aberto, convido vocês a contribuirem e implementarem esta funcionalidade.</p>
</blockquote>
<h2 id="modificando-nossa-api">⌨️ Modificando nossa API</h2>
<p>Que tal adicionar <em>circuit breaker</em> em nosso sistema?</p>
<p>🗣️ Quais seriam os pontos onde deveríamos adicionar o circuit breaker? Em caso de falha o que faremos, retornaremos o valor em cache? Vamos adicionar algum recurso para isto como o <code>Redis</code>?</p>
<p>Será que esta técnica é mesmo necessária no nosso projeto?</p>
<p>Reflita sobre estes questionamentos.</p>
<p>Estas discussões são importantes e todas elas têm um "trade off", ou seja, podem ter algum custo.</p>
<h2 id="salvando-a-versao-atual-do-codigo">💾 Salvando a versão atual do código</h2>
<p>Caso decida modificar o seu código para utilizar circuit breaker, como estamos adicionando novas bibliotecas ao nosso projeto e possivelmente mais código também, vamos salvar a versão atual do código.</p>
<p>Adicione os arquivos que foram modificados com o comando <code>git add</code> e em seguida consolide a nova versão com o comando <code>git commit -m "Adicionando circuit breaker"</code>.</p>
<p>Não esqueça de enviar as alterações para o servidor remoto com o comando <code>git push</code>.</p>
<p>Nesse ponto temos uma API que melhoramos o tempo de resposta e aumentamos a robustez. Só isto é suficiente? Na verdade temos várias outras técnicas que podemos usar para melhorar a nossa API.</p>
<p>😊 Olha tudo que fizemos até agora!🎈 Vamos continuar?</p>
<blockquote>
<p>🐂 Uma api robusta deve estar preparada para lidar com falhas.</p>
</blockquote>

              
            </article>
            
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Rodapé" >
      
        
        <a href="../assincrono/" class="md-footer__link md-footer__link--prev" aria-label="Anterior: 🐆 Processos assíncronos" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              🐆 Processos assíncronos
            </div>
          </div>
        </a>
      
      
        
        <a href="../avancadas/" class="md-footer__link md-footer__link--next" aria-label="Próximo: 🦸 Técnicas (um pouco mais avançadas)" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              🦸 Técnicas (um pouco mais avançadas)
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.tabs.link"], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.more.one": "Mais 1 nesta p\u00e1gina", "search.result.more.other": "Mais # nesta p\u00e1gina", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.placeholder": "Digite para iniciar a busca", "search.result.term.missing": "Ausente", "select.version.title": "Selecione a vers\u00e3o"}}</script>
    
    
      <script src="../assets/javascripts/bundle.0238f547.min.js"></script>
      
    
  </body>
</html>